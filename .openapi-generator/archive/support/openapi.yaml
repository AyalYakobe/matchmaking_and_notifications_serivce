openapi: 3.0.3
info:
  title: Matchmaking, Offers, and Composite API
  version: 1.0.0
  description: |
    Fully updated OpenAPI specification based on the actual FastAPI implementation.
    Includes MATCH, OFFER, and COMPOSITE endpoints.

servers:
  - url: http://localhost:8000
    description: Local development server

paths:

  ############################################################
  # MATCH ROUTES
  ############################################################

  /matches:
    get:
      tags: [Matches]
      summary: List matches
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            default: 25
        - in: query
          name: offset
          schema:
            type: integer
            default: 0
      responses:
        "200":
          description: List of matches
          headers:
            Link:
              schema:
                type: string
              description: Pagination link header
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Match"

    post:
      tags: [Matches]
      summary: Create a match
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MatchCreate"
      responses:
        "201":
          description: Match created
          headers:
            Location:
              schema:
                type: string
            Content-Location:
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Match"

  /matches/{match_id}:
    get:
      tags: [Matches]
      summary: Get match by ID
      parameters:
        - name: match_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Match found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Match"
        "404":
          description: Match not found

    patch:
      tags: [Matches]
      summary: Update match (partial)
      parameters:
        - name: match_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MatchUpdate"
      responses:
        "200":
          description: Match updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Match"
        "404":
          description: Match not found

    put:
      tags: [Matches]
      summary: Update match (full)
      parameters:
        - name: match_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MatchUpdate"
      responses:
        "200":
          description: Match updated
        "404":
          description: Match not found

    delete:
      tags: [Matches]
      summary: Delete match
      parameters:
        - name: match_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "204":
          description: Match deleted
        "404":
          description: Match not found

  /matches/{match_id}/full:
    get:
      tags: [Matches]
      summary: Full joined match information
      parameters:
        - name: match_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Full match details
          content:
            application/json:
              schema:
                type: object
        "404":
          description: Match not found

  /matches/{match_id}/async:
    post:
      tags: [Matches]
      summary: Start async processing for match
      parameters:
        - name: match_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "202":
          description: Async task started
          headers:
            Location:
              schema:
                type: string
            Retry-After:
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AsyncTaskStart"

  /matches/async/tasks/{task_id}:
    get:
      tags: [Matches]
      summary: Get async task status
      parameters:
        - name: task_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Task status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AsyncTask"
        "404":
          description: Task not found


  ############################################################
  # OFFER ROUTES
  ############################################################

  /offers:
    get:
      tags: [Offers]
      summary: List offers
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            default: 10
        - in: query
          name: offset
          schema:
            type: integer
            default: 0
      responses:
        "200":
          description: List of offers
          headers:
            ETag:
              schema:
                type: string
            Link:
              schema:
                type: string
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Offer"

    post:
      tags: [Offers]
      summary: Create offer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OfferCreate"
      responses:
        "201":
          description: Offer created
          headers:
            Location:
              schema:
                type: string
            Content-Location:
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Offer"


  /offers/{offer_id}:
    get:
      tags: [Offers]
      summary: Get offer by ID
      parameters:
        - name: offer_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Offer found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Offer"
        "404":
          description: Offer not found

    put:
      tags: [Offers]
      summary: Update offer
      parameters:
        - name: offer_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OfferUpdate"
      responses:
        "200":
          description: Offer updated
        "404":
          description: Offer not found

    patch:
      tags: [Offers]
      summary: Update offer (partial)
      parameters:
        - name: offer_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OfferUpdate"
      responses:
        "200":
          description: Offer updated
        "404":
          description: Offer not found

    delete:
      tags: [Offers]
      summary: Delete offer
      parameters:
        - name: offer_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "204":
          description: Offer deleted
        "404":
          description: Offer not found


  ############################################################
  # COMPOSITE ROUTES (MS1 + MS2)
  ############################################################

  /ms1/health:
    get:
      tags: [Composite]
      summary: MS1 health check
      responses:
        "200":
          description: MS1 response

  /ms1/donors:
    get:
      tags: [Composite]
      summary: List donors
      responses:
        "200":
          description: Donor list

  /ms1/donors/{donor_id}:
    get:
      tags: [Composite]
      summary: Get donor
      parameters:
        - name: donor_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Donor found

  /ms1/donors/{donor_id}/organs:
    get:
      tags: [Composite]
      summary: List donor organs
      parameters:
        - name: donor_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Organs retrieved

  /ms1/organs:
    get:
      tags: [Composite]
      summary: List organs
      responses:
        "200":
          description: Organ list

  /ms1/consents:
    get:
      tags: [Composite]
      summary: List consents
      responses:
        "200":
          description: Consent list

  /ms1/consents/{consent_id}:
    get:
      tags: [Composite]
      summary: Get consent
      parameters:
        - name: consent_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Consent found

  /ms1/all:
    get:
      tags: [Composite]
      summary: Full MS1 snapshot
      responses:
        "200":
          description: Snapshot

  /ms2/recipients:
    get:
      tags: [Composite]
      summary: List recipients
      responses:
        "200":
          description: Recipients

  /ms2/recipients/{recipient_id}:
    get:
      tags: [Composite]
      summary: Get recipient
      parameters:
        - name: recipient_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Recipient found

  /ms2/recipients/{recipient_id}/needs:
    get:
      tags: [Composite]
      summary: List needs for recipient
      parameters:
        - name: recipient_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Needs list

  /ms2/needs:
    get:
      tags: [Composite]
      summary: List needs
      responses:
        "200":
          description: Needs

  /ms2/needs/{need_id}:
    get:
      tags: [Composite]
      summary: Get need
      parameters:
        - name: need_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Need found

  /ms2/hospitals:
    get:
      tags: [Composite]
      summary: List hospitals
      responses:
        "200":
          description: Hospitals

  /ms2/hospitals/{hospital_id}:
    get:
      tags: [Composite]
      summary: Get hospital
      parameters:
        - name: hospital_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Hospital found

  /ms2/all:
    get:
      tags: [Composite]
      summary: Full MS2 snapshot
      responses:
        "200":
          description: Snapshot

  /aggregate/full-snapshot:
    get:
      tags: [Composite]
      summary: Get full composite snapshot
      responses:
        "200":
          description: Snapshot


############################################################
# COMPONENT SCHEMAS
############################################################

components:
  schemas:

    Match:
      type: object
      properties:
        id:
          type: integer
        donorId:
          type: string
        organId:
          type: string
        status:
          type: string
      required: [donorId, organId]

    MatchCreate:
      type: object
      properties:
        donorId:
          type: string
        organId:
          type: string
      required: [donorId, organId]

    MatchUpdate:
      type: object
      properties:
        donorId:
          type: string
        organId:
          type: string
        status:
          type: string

    AsyncTaskStart:
      type: object
      properties:
        task_id:
          type: string
        status:
          type: string
          example: running

    AsyncTask:
      type: object
      properties:
        task_id:
          type: string
        status:
          type: string
        result:
          type: object
          nullable: true

    Offer:
      type: object
      properties:
        id:
          type: integer
        matchId:
          type: integer
        status:
          type: string
      required: [matchId]

    OfferCreate:
      type: object
      properties:
        matchId:
          type: integer
      required: [matchId]

    OfferUpdate:
      type: object
      properties:
        matchId:
          type: integer
        status:
          type: string
